---
title: "Fernerkundung globale Ökologie: 5. Feuer"
author: "[Lasslop](mailto:gitta.lasslop@senckenberg.de)/[Werner](mailto:christian.werner@senckenberg.de)"
classoption: a4paper
#lang: de-DE
bibliography: /home/gitta/R/Lehre/FE_OEKOLOGIE/fe_oekologie_2018/handouts/literatur.bib
output:
  tufte::tufte_handout:
##    latex_engine: xelatex
    fig_caption: yes
    includes:
      in_header: styles.tex
##    toc: true
    highlight: default
---
# Evaluierung?
# Feuer

MODIS Kürzel: [MCD45A1](https://ladsweb.modaps.eosdis.nasa.gov/missions-and-measurements/products/burned-area/MCD45A1/). Die Webseite zu diesem Product wurde leider vor ein paar Wochen offline genommen, da schon neue Produkte verfügbar sind. Daher ist online keine ausführliche Beschreibung mehr vorhanden.

## Literatur
@roy_collection_2008; @giglio_global_2006

## Initialisieren
Sollten Sie eine Fehlermeldung beim Laden der Pakete bekommen installieren Sie diese bitte als erstes nochmal neu mit dem code aus der 1. Stunde:
```{r, message=FALSE, warning=FALSE,eval=FALSE}
for (p in c("raster", "rgeos", "ggplot2", "rworldmap", "maps", "mapproj", "rgdal", "devtools")) {
  if (!require(p, character.only=TRUE)) {
    install.packages(p)
    library(p, character.only=TRUE)
  }
}

library("devtools")
install_github("joergsteinkamp/FEglobaleOekologie")

```

Laden der benötigten Pakete, sowie initialisieren der Umgebungsvariablen.
```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(raster)
library(plyr)
library(ggplot2)
library(gganimate)
library(FEglobaleOekologie)
fegloekOptions(baseDir = "/home/gitta/R/Lehre/")
fegloekOptions(region="SAFRICA")
fegloekInit()
```
```{r, message=FALSE, warning=FALSE, eval=FALSE}
library(raster)
library(plyr)
library(ggplot2)
library(FEglobaleOekologie)
fegloekOptions(baseDir = "IhrBaseDir")
fegloekOptions(region="SAFRICA")
fegloekInit()

## Installation des Zusatzpakets
## library(devtools)
## devtools::install_github("dgrtwo/gganimate")

## laden des neuen Pakets
library(gganimate)
```
Laden der in den letzten Stunden geschriebenen Funktionen und gespeicherten Variablen.
```{r}
source(file.path(getOption("fegloekBaseDir"), "R", "variables.R"), encoding=getOption("encoding"))
source(file.path(getOption("fegloekBaseDir"), "R", "functions.R"), encoding=getOption("encoding"))
```
Download der Daten von https://powerfolder.gwdg.de/filestable/MjRGYXU2YUViNThFdU5yMlFhZXV2 (Fire_region.zip), die entpackten Dateien sollen in folgendem Verzeichnis liegen.
```{r, message=FALSE, warning=FALSE,eval=FALSE}
file.path(getOption("fegloekDataDir"), getOption("fegloekRegion"))
```

## Einlesen und verarbeiten der Daten

Laden der Landnutzungsklassen und erzeugen eine Maske, bei der Land 1 ist,
Wasser und Unklassifiziert 0. Anzeigen der Gesamtpixelzahl und Anzahl der Landpixel
erfolgt mit "nrow". Zusätzlich wird eine Spalte mit dem Namen der
Landbedeckungsklasse erzeugt.

```{r}
data.dir <- file.path(getOption("fegloekDataDir"), getOption("fegloekRegion"))
dfLCT <- geotiff2df(file.path(data.dir, "MCD12Q1_2010-01-01.Land_Cover_Type_3.tif"), "id")
dfLCT$mask = 1
dfLCT$mask[dfLCT$id >= 254] = 0
dfLCT$mask[dfLCT$id == 0] = 0

nrow(dfLCT)
dfLCT = subset(dfLCT, mask == 1)
nrow(dfLCT)

dfLCT = merge(dfLCT, LCT3lookuptable, by="id", all.x=TRUE)
```

\marginnote{
\textbf{Aufgabe}\\
1. Wie groß is der Landanteil in Ihrer bearbeiteten Region? 

2. Wie bereits bei NPP besprochen, gibt es auch hier Fehlklassifizierungen. Es
macht zum Beispiel keinen Sinn, Nadelwälder in Äquatornähe zu haben. Diese
können Sie durch obige Maskierung ebenfalls aus dem Datensatz entfernen.
}

Im Folgendem werden monatliche Feuerdaten eingelesen und gezählt, wie viele
Pixel pro Monat gebrannt haben. Die Ergebnisse werden in den data.frames
tsFire und tsLCTFire gespeichert. Die Schleife dauert recht lange, verlieren Sie nicht
die Geduld oder gehen Sie Essen. Sie können die Zeile "print"
aktivieren, um eine Fortschrittsanzeige zu bekommen.

```{r, message=FALSE}
files  <- list.files(data.dir, pattern="burndate.tif$", full.names=TRUE)
date   <- extractDate(files)
tsFire <- data.frame(date=date, count=0)

if (exists("tsLCTFire"))
  rm(tsLCTFire)

for (i in 1:length(files)) {
  dfFire <- geotiff2df(files[i], "burndate", valid_range=c(0, 366))
  dfMerged <- merge(dfFire, dfLCT, by=c("x", "y"))
  if (nrow(dfFire) > 0) {
    tsFire$count[i] = nrow(dfMerged)
  

  if (exists("tsLCTFire")) {
    tsLCTFire <- rbind(tsLCTFire,
                       cbind(ddply(dfMerged, c("name"), summarize,
                                   count=length(burndate)), date=date[i]))
  } else {
    tsLCTFire <- cbind(ddply(dfMerged, c("name"), summarize,
                             count=length(burndate)), date=date[i])
  }
  }
#  print(paste0(round(i / (length(files)) * 100, 1), "% "))
}
```

## Darstellen der Daten

Erzeugen Sie eine PDF Datei, mit der Zeitserie:

\marginnote{
\textbf{Aufgabe}\\
Welche Einheit muss auf der y-Achse stehen?

Überlegen Sie, wie Sie das als Anteil in Prozent der gesamten
Landfläche berechnen können?
}

```{r, message=FALSE, warning=FALSE}
p <- ggplot(tsFire, aes(x=date, y=count))
p <- p + geom_bar(stat="identity", fill="red")
p <- p + scale_x_date()
p <- p + xlab("Datum")
p <- p + ylab("burned")
```
```{r, eval=FALSE}
file <- paste0(getOption("fegloekRegion"), "_Fire.pdf")
pdf(file.path(getOption("fegloekFigDir"), file), paper="special", width=8, height=3)
print(p)
dev.off()
```
```{r, echo=FALSE, fig.width=6, fig.height=3}
print(p)
```

Um heraus zu finden, was gebrannt hat, wird hier die Fläche nach Landnutzung
klassifiziert und für jede Landbedeckungsklasse eine Zeitreihe geplottet.


```{r}
p <- ggplot(tsLCTFire, aes(x=date, y=count))
p <- p + geom_bar(stat="identity",fill="red")
p <- p + scale_x_date()
p <- p + xlab("Datum")
p <- p + ylab("burned")
p <- p + facet_wrap(~name, ncol=3)
```
```{r, eval=FALSE}
file <- paste0(getOption("fegloekRegion"), "_FireTSLCT.pdf")
pdf(file.path(getOption("fegloekFigDir"), file), paper="special", width=12, height=6)
print(p)
dev.off()
```
```{r, echo=FALSE, fig.width=8, fig.height=5}
print(p)
```

## Räumliche Feuerverbreitung

-------------------------------------------------------
**Hinweis**

Dieser Teil ist nur sinnvoll, wenn "genügend" Pixel gebrannt haben, damit das auf
der Karte sichtbar wird. Überlegen Sie selbst, ob Sie in Ihrer Region weiter machen
oder zu einer anderen Region wechseln sollten.
-------------------------------------------------------

Die Ländergrenzen werden mit borderSubset auf unseren Kartenausschnitt zugeschnitten und auf UTM umprojiziert.
\marginnote{
\textbf{Aufgabe}\\
Auch wenn die Angabe in km$^2$ groß erscheint, sind die Feuerpixel doch kaum
zu sehen. Definieren Sie einen Bereich (fireExtent) auf den die Bilder zugeschnitten
werden (crop), damit die "Feuer" besser zu sehen sind.
}
```{r, eval=FALSE}
rFire <- raster(files[1])
rFire[rFire>366]=NA
rFire <- crop(rFire, fireExtent)
regionmap <- borderSubset(rFire)
```

```{r, eval=FALSE}
files <- list.files(data.dir, pattern='.*burndate.tif$',
                    full.names=TRUE)
date  <- extractDate(files)
```

Jeder Zeitschritt wird einzeln eingelesen und als Grafik  ausgegeben.
Diese Bilder können anschließend in eine Animation umgewandelt werden.

```{r, eval=FALSE}
## empty list of data.frames (will be combined after loop)
list_of_dfFires <- list()

for (i in 1:length(files)) {
  dfFire <- geotiff2df(files[i], "burndate", crop=fireExtent)
  dfFire$state=""

  dfFire = subset(dfFire, burndate != 11111)

  dfFire$state[dfFire$burndate == 0] = "unburned"
  dfFire$state[dfFire$burndate > 0] = "burned"
  dfFire$state[dfFire$burndate == 900] = "snow or high aerosol"
  dfFire$state[dfFire$burndate == 9998] = "water"
  dfFire$state[dfFire$burndate == 9999] = "water"
  dfFire$state[dfFire$burndate == 10000] = "insufficient data"
  dfFire$state <- factor(dfFire$state, levels=c("unburned", "burned",
                 "snow or high aerosol", "water", "insufficient data"))
  dfFire$year = i

}
## Verknuepfung der einzelnen dfLCT data.frames zu einem grossen data.frame
dfFireAll <- do.call("rbind", list_of_dfFires)

p <- ggplot(dfFire, aes(x=x, y=y, frame=year))
p <- p + geom_raster(aes(fill=state))
p <- p + geom_path(data=regionmap, size=0.1, colour="black", aes(x=long, y=lat, group=group))
p <- p + scale_fill_manual(values=c("unburned"="darkgreen", "burned"="orange",
                 "snow or high aerosol"="lightyellow", "water"="lightblue",
                 "insufficient data"="grey60"), drop=FALSE)
p <- p + coord_fixed(xlim=c(min(dfFire$x), max(dfFire$x)),
                       ylim=c(min(dfFire$y), max(dfFire$y)))
p <- p + xlab("easting")
p <- p + ylab("northing")
p <- p + labs(title = paste("Fire", date[i]))
print(p)

print(paste0(round(i / (length(files)) * 100, 1), "% "))

```


# Aufgaben
1. Erstellen Sie eine Abbildung der mehrjährigen, Monatsmittel der Feuerdynamik? Gehen Sie dabei  analog zur Hausaufgabenlösung des Phänologie Handouts vor. **(3 Punkte)**

2. Erreicht die Feueraktivität für alle Landnutzungsklassen im selben Monat ihr Maximum? Um dies Abschätzen zu können erstellen Sie ein Liniendiagram (mit geom_line()) der Zeitreihe an. Die Farbe der Linie soll die Landbedeckungstypen darstellen. Da die Größenordnung der Feueraktivitäten der einzelnen Landbedeckungstypen eventuell sehr unterschiedlich ist könnte es sinnvoll sein den Logarithmus der Feueraktivität zu benutzen. Welche zusätzlichen Zeilen code und/ oder welche Änderungen sind dafür notwendig? **(2 Punkte)**

3. Beschreiben Sie was der Aufruf geom_raster(aes(fill=state)) und der Aufruf geom_path(data=regionmap, size=0.1, colour="black", aes(x=long, y=lat, group=group)) zu dem Plotobjekt hinzufügt. **(2 Punkt)**

# Literatur
