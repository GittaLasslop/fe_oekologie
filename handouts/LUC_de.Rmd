---
title: "Fernerkundung globale Ökologie: 4. Landnutzungsänderung"
author: "[Lasslop](mailto:gitta.lasslop@senckenberg.de)/[Werner](mailto:christian.werner@senckenberg.de)"
classoption: a4paper
#lang: de-DE
bibliography: literatur.bib
output:
#  tufte::tufte_handout:
   pdf_document:
##    latex_engine: xelatex
 #   fig_caption: yes
#    includes:
#      in_header: styles.tex
##    toc: true
    highlight: default
---

# Landbedeckung

Über den jährlich ermittelten Landbedeckungstypen (Land cover type, LCT) lässt sich die Veränderung der Landnutzung über den Zeitraum der vorhandenen Satellitenmessungen ermitteln.

## Daten
Das MODIS Kürzel für die heutige Sitzung ist [MCD12Q1](https://lpdaac.usgs.gov/dataset_discovery/modis/modis_products_table/mcd12q1).

## Literatur
Generelle Literatur zu den relevanten MODIS Produkten:  
@Mertes2015Detectingchangeurban @Yin2014MappingAnnualLand @Broich2011Remotelysensedforest @Friedl2010MODISCollectionglobal @Schneider2009newmapglobal

Für eine Diskussion von Unsicherheiten der genutzten Produkte:  
@Fritz2011Highlightingcontinueduncertainty @Park2014CharacteristicsMODISlandcover

## Initialisieren
Laden der benötigten Pakete, sowie initialisieren der Umgebungsvariablen.
```{r, message=FALSE, warning=FALSE,echo=FALSE}
library(raster)
library(ggplot2)
library(reshape2)
library(rworldmap)

setwd('/home/gitta/R/Lehre/FE_OEKOLOGIE/fe_oekologie_2019/handouts')
```
```{r, message=FALSE, warning=FALSE,eval=FALSE}
library(raster)
library(ggplot2)
library(reshape2)
library(rworldmap)

```
Die benötigten Fernerkundungsdaten finden Sie auf dem T Laufwerk. Kopieren Sie die Dateien auf ihr S Laufwerk in den folgenden Ordner:
```{r, message=FALSE, warning=FALSE, eval=FALSE}
'S:/FGOE/data/LUC/BORNEO'
```

Ausserdem benötigen wir die Funktion *geotiff2df()* aus den letzten Sitzungen. Kopieren Sie den Quelltext der Funktion in dieses Script oder laden Sie die Funktion aus einer externen Datei *functions.R* (in ihrem OLAT_Skript haben wir die Funktion der letzten Sitzung schon eingefügt - generell ist es aber ratsam bei größeren Projekten häufig verwendete Funktionen in externe Dateien auszulagern und mit source in the Laufzeitumgebung zu laden).

```{r, messsage=FALSE}
source(file.path("R", "functions.R"), encoding=getOption("encoding"))
```


Erweitern Sie die Funktion *geotiff2df()* so, dass Sie mit der Übergabe eines optionalen Arguments "crop_extent" die Ausgabe beschneiden können. Hierzu  benötigen Sie:  
(1) ein zusaetzliches Funktionsargument ('crop_extent') mit dem Standardwert NA (für 'nicht definiert') und  
(2) den Befehl crop (?crop) um die Ausdehnung unserer Karte auf die Grenzen 'crop_extent' zu beschneiden.   
In unserem heutigen Skript haben wir die Position für die Funktionserweiterung mit einem Kommentar markiert. **Hinweis:** Für den Aufbau der if-Bedingung können Sie sich bei der folgenden Abfrage von 'valid_range' in der Funktion inspirieren lassen.


## Verarbeiten der Daten

In unseren MODIS Beispiel-Daten sind LUC Informationen für die Jahre 2001 -- 2010 vorhanden. Wir vergleichen erstmal die Landoberflächenbedeckung für das erste Jahr im Vergleich zum letzen Jahr.

```{r}
start_year <- 2002
end_year <- 2010
```


Die Jahre werden in einer for-Schleife zwischen start_year und end_year durchlaufen und mit jedem Durchlauf wird berechnet, wieviel Pixel als bewaldet und unbewaldet klassifiziert sind. Im ersten Jahr (year == start_year) wird der data.frame tsForest erzeugt und in den folgenden Jahren wird diesem data.frame je eine Zeile hinzugefügt (rbind, "row bind"). Für das erste und letze Jahr wird eine Karte erzeugt (Hinweis: die Daten der Region BORNEO für das Jahr 2001 enthalten ungewöhnlich viele nicht-klassifizierte Pixel - starten hier deshalb mit dem Jahr 2002; generell sollten Sie bei LUC Analysen immer prüfen ob Unregelmässigkeiten in einer Zeitscheibe zu beobachten sind - sie könnten sich auch die Quality Control Daten des Produkts ansehen; diese finden Sie auf der MODIS-Homepage als separaten Datensatz).


```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE, fig.width=5, fig.height=4, fig.margin=TRUE}
forestExtent <- c(-280000   ,    0   ,    0  ,250000)
data.dir <- 'data/LUC/BORNEO'
for (year in start_year:end_year) {
  file <- paste0("MCD12Q1_", year ,"-01-01.Land_Cover_Type_3.tif")
  dfLCT <- geotiff2df(file.path(data.dir, file), name="id", crop_extent =forestExtent, valid_range = c(0, 253))


  dfLCT$name=""
  dfLCT$name[dfLCT$id < 5 | dfLCT$id > 8] = "unforested"
  dfLCT$name[dfLCT$id > 4 & dfLCT$id < 9] = "forested"
  dfLCT$name[dfLCT$id == 0] = "water"

  nFor = length(dfLCT$name[dfLCT$name == "forested"])
  nUnf = length(dfLCT$name[dfLCT$name == "unforested"])

  if (year == start_year) {
    tsForest = data.frame(Year=year, forested=nFor, unforested=nUnf)
  } else {
    tsForest = rbind(tsForest, data.frame(Year=year, forested=nFor, unforested=nUnf))
  }

  if (year == start_year || year == end_year) {
    p <- ggplot(dfLCT, aes(x=x, y=y))
    p <- p + geom_raster(aes(fill=name))
    p <- p + coord_fixed(xlim=c(min(dfLCT$x), max(dfLCT$x)),
                         ylim=c(min(dfLCT$y), max(dfLCT$y)))
    p <- p + theme(legend.position = "bottom")
    p <- p + scale_fill_manual(values=c("unforested"="brown", "forested"="darkgreen",
                                        "water"="lightblue"), drop=FALSE)
    p <- p + guides(fill = guide_legend(title=NULL, ncol = 4))
    label = paste0(nFor, " * km^2")
    p <- p + annotate("text", label=label, x=3e5, y=9.05e6,
                      color="white", parse=TRUE, size=6)
    label = paste0(nUnf, " * km^2")
    p <- p + annotate("text", label=label, x=-1e5, y=1.5e6,
                      color="white", parse=TRUE, size=6)
    p <- p + labs(title=year)
    p <- p + xlab("easting")
    p <- p + ylab("northing")
    file <- paste0("plots/BORNEO_LUC_", year, ".pdf")
    print(p)
  }
}
```

Der *crop* Befehl schneidet eine von uns vordefinierte Region aus den Daten aus. Diese Region muss als zusätzliches/ optionales Funktionsargument der Funktion 'geotiff2df()' übergeben werden. 

Anschliessend wird für jedes Jahr eine neue Spalte erzeugt, die Wald und nicht bewaldete Gebiete unterscheidet. Die Klassifikation in Wald / Nicht-Wald erfolgt mittels der zuletzt definierten Variable in LCT3lookuptable. Anschließend wird die Anzahl der bewaldeten und unbewaldeten Pixel pro Jahr gezählt und in dem data.frame tsForest gespeichert.

--------------------------
**Aufgabe**
Aktivieren Sie innerhalb der Schleife die Zeilen mit 'annotate' und 
wählen sie die X- und Y-Koordinaten so, das die Informationen innerhalb 
der Karte erscheinen (Hinweis: der Befehl 'extent(rLCT)' gibt Ihnen 
die Limits der Karte aus).
---------------------------

```{r, eval=FALSE}
forestExtent = c(-280000, 0, 0, 250000)
data.dir = 'Pfad zu ihrem Datenordner'
for (year in start_year:end_year) {
  file <- paste0("MCD12Q1_", year ,"-01-01.Land_Cover_Type_3.tif")
  dfLCT <- geotiff2df(file.path(data.dir, file), name="id", 
                      crop_extent =forestExtent, valid_range = c(0, 253))
  
  dfLCT$name = ""
  dfLCT$name[dfLCT$id < 5 | dfLCT$id > 8] = "unforested"
  dfLCT$name[dfLCT$id > 4 & dfLCT$id < 9] = "forested"
  dfLCT$name[dfLCT$id == 0] = "water"

  nFor = length(dfLCT$name[dfLCT$name == "forested"])
  nUnf = length(dfLCT$name[dfLCT$name == "unforested"])

  if (year == start_year) {
    tsForest = data.frame(Year=year, forested=nFor, unforested=nUnf)
  } else {
    tsForest = rbind(tsForest, data.frame(Year=year, forested=nFor, unforested=nUnf))
  }

  if (year == start_year || year == end_year) {
    p <- ggplot(dfLCT, aes(x=x, y=y))
    p <- p + geom_raster(aes(fill=name))
    p <- p + coord_fixed(xlim=c(min(dfLCT$x), max(dfLCT$x)),
                         ylim=c(min(dfLCT$y), max(dfLCT$y)))
    p <- p + theme(legend.position = "bottom")
    p <- p + scale_fill_manual(values=c("unforested"="brown", "forested"="darkgreen",
                                        "water"="lightblue"), drop=FALSE)
    p <- p + guides(fill = guide_legend(title=NULL, ncol = 4))
    p <- p + labs(title=year)
    p <- p + xlab("easting")
    p <- p + ylab("northing")
    file <- paste0("Borneo_LUC_", year, ".pdf")
    pdf("Pfad zu ihrem Plot Ordner", file), paper="special", width=10, height=6)
    print(p)
    dev.off()
  }
}
```

Nun plotten wir die Zeitreihe. Dafür werden die Spalten 'forested' und 'unforested' mit dem Befehl 'melt' in einer Spalte namens 'value' kombiniert und eine zusätzliche Spalte names 'variable' erzeugt, die die entsprechenden alten Spaltennamen 'forested'/'unforested' enthält. Falls sich die Größen der zwei Landnurzungklassen in ihrer Region sehr stark unterscheiden können Sie mit dem Befehl 'facet_wrap' die Balken der Klassen in interschiedlichen Panelen plotten und so Trends leichter sichtbar machen. Denken Sie daran, die Variablen entsprechend ihrer obigen Definition umzubenennen.

```{r}
tsForest = melt(tsForest, measure.vars=c("forested", "unforested"))
p <- ggplot(tsForest, aes(x=Year, y=value, fill=variable))
p <- p + geom_bar(stat="identity", position="dodge")
p <- p + scale_fill_manual(values=c("unforested"="brown", "forested"="darkgreen",
                                        "water"="lightblue"), drop=FALSE)

## p <- p + facet_wrap(~variable, ncol=1, scales="free_y")
```
```{r, eval=FALSE}
file <- paste0("BORNEO_LUC_TS.pdf")
pdf(file.path('plots/LUC/', file), paper="special", width=10, height=6)
print(p)
dev.off()
```

```{r, fig.width=8, fig,height=5, echo=FALSE}
print(p)
```

```{r}
forestExtent <- c(-280000   ,    0   ,    0  ,250000)
data.dir <- 'data/LUC/BORNEO'
  file <- paste0("MCD12Q1_", year ,"-01-01.Land_Cover_Type_3.tif")
# Vergleich erstes und letztes Jahr, was passiert mit den bewaldeten pixeln die entwaldet wurden.
# 1. plotten der Karten
# 2. tracken der änderungen
```

# Vergleich mit dem ESA Datensatz
1) umprojizieren
2) Ist die klassifizierung vergleichbar?
3) welche pixel sind gleich klassifiziert
4) für welche klassen gibt es die größten unterschiede


# Hausaufgaben

1. Beschriften Sie die Achsen korrekt (Hinweis: ?xlab, ?ylab). **(0.5 Punkte)**

2. In dem Skript wird das Verhältnis Wald zu nicht-Wald in einem kleinem Ausschnitt betrachtet. Überlegen Sie sich eine eigene Klassifizierung (Urbanisierung, Landwirtschaft, Verbuschung, ...) für Ihre Region und passen Sie die Variablennamen und die Klassifizierung entsprechend an. Eventuell muss auch der zu benutzende Ausschnitt verändert werden (forestExtent; schauen Sie sich den bisherigen Wert an um die Angabe zu verstehen), damit zum Beispiel eine Stadt enthalten ist. **(2 Punkte)**

3. Beschriften Sie die x-Achse des Zeitreihen-Plots mit ganzen Zahlen damit es eher einer Zeitachse mit Jahren entspricht (?scale_x_continuous). **(0.5 Punkte)**

4. Modifizieren Sie den Plot indem sie die Balkendarstellung durch Linien ersetzen. **(1 Punkt)**

6. Mit welcher Funktion können Sie in R Spalten an einen data.frame anhängen? **(1 Punkt)**

7. Nennen Sie mindestens eine Funktion mit der man in R die Anzahl der Zeilen in einem data.frame herausfinden kann. **(1 Punkt)**


# Literatur
