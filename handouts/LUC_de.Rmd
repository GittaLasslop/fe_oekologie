---
title: "Fernerkundung globale Ökologie: 1. Landnutzungsänderung"
author: "[Lasslop](mailto:gitta.lasslop@senckenberg.de)/[Werner](mailto:christian.werner@senckenberg.de)"
classoption: a4paper
lang: de-DE
bibliography: /home/gitta/R/Lehre/FE_OEKOLOGIE/fe_oekologie_2018/handouts/literatur.bib
output:
  tufte::tufte_handout:
##    latex_engine: xelatex
    fig_caption: yes
    includes:
      in_header: styles.tex
##    toc: true
    highlight: default
---

# Landnutzungswandel/Land-Use Change (LUC)

Über den jährlich ermittelten Landnutzungstypen (Land cover type, LCT) lässt sich die Veränderung der Landnutzung über den Zeitraum der vorhandenen Satellitenmessungen ermitteln.

MODIS Kürzel ist [MCD12Q1](https://lpdaac.usgs.gov/dataset_discovery/modis/modis_products_table/mcd12q1)

## Literatur
1. Generell: @mertes_detecting_2015 @yin_mapping_2014 @broich_remotely_2011 @friedl_modis_2010 @schneider_new_2009

2. Unsicherheiten: @fritz_highlighting_2011 @park_characteristics_2014

## Initialisieren
Laden der benötigten Pakete, sowie initialisieren der Umgebungsvariablen.
```{r, message=FALSE, warning=FALSE}
library(raster)
library(ggplot2)
library(reshape2)
library(FEglOek)
fegloekOptions(baseDir = "/data/Lehre/FE_Oekologie")
fegloekOptions(region="BORNEO")
```
Laden der in den letzten Stunden geschriebenen Funktion.
```{r}
source(file.path(getOption("fegloekBaseDir"), "R", "functions.R"), encoding=getOption("encoding"))
```

Laden Sie die Daten runten und verschieben Sie die entzippten Dateien in den foglenden Ordner:
```{r, message=FALSE, warning=FALSE}
file.path(getOption("fegloekDataDir"), getOption("fegloekRegion"))
```

## Verarbeiten der Daten

Die LUC Daten sind für die Jahre 2001 -- 2010 vorhanden. Die Jahre werden in einer for-Schleife zwischen start_year und end_year durchlaufen und mit jedem Durchlauf wird berechnet, wieviel Pixel bewaldet und unbewaldet sind. Im ersten Jahr (year == start_year) wird der data.frame tsForest erzeugt und in den folgenden Jahren wird diesem data.frame je eine Zeile hinzugefügt (rbind, "row bind"). Für das erste und letze Jahr wird eine Karte erzeugt.

```{r}
start_year <- 2001
end_year <- 2010
```

Der crop Befehl schneidet eine von uns vordefinierte Region (getOption("fegloekLUCExtent")) aus den Daten aus, dieser muss als Erweiterung in die im letzen Skript geschriebene Funktion 'geotiff2df()' als Parameter eingebaut werden, ebenso wie 'valid_range'. Die Daten liegen in UTM-Projektion vor, um Ländergrenzen dazustellen muss die vorhandene Karte auf die jeweilige Projektion der Region umprojiziert werden. Das wird in der von uns geschriebenen Funktion 'borderSubset()' gemacht.

Es wird pro Jahr eine neue Spalte erzeugt, die Wald und nicht bewaldete Gebiete unterscheidet. Was Wald und nicht Wald ist, kann der zuletzt definierten Variable LCT3lookuptable entnommen werden. Anschließend  wird die Anzahl der bewaldeten und unbewaldeten Pixel pro Jahr gezählt und in dem data.frame tsForest gespeichert.

```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE, fig.width=5, fig.height=4, fig.margin=TRUE}
forestExtent <- getOption("fegloekLUCExtent")
data.dir <- file.path(getOption("fegloekDataDir"), getOption("fegloekRegion"))
for (year in start_year:end_year) {
  file <- paste0("MCD12Q1_", year ,"-01-01.Land_Cover_Type_3.tif")
  dfLCT <- geotiff2df(file.path(data.dir, file), name="id", crop=forestExtent, valid_range = c(0, 253))

  # reproject border lines, if not yet done
  if (!exists("regionmap")) {
    rLCT <- raster(file.path(data.dir, file))
    rLCT = crop(rLCT, forestExtent)
    regionmap = borderSubset(rLCT)
  }

  dfLCT$name=""
  dfLCT$name[dfLCT$id < 5 | dfLCT$id > 8] = "unforested"
  dfLCT$name[dfLCT$id > 4 & dfLCT$id < 9] = "forested"
  dfLCT$name[dfLCT$id == 0] = "water"

  nFor = length(dfLCT$name[dfLCT$name == "forested"])
  nUnf = length(dfLCT$name[dfLCT$name == "unforested"])

  if (year == start_year) {
    tsForest = data.frame(Year=year, forested=nFor, unforested=nUnf)
  } else {
    tsForest = rbind(tsForest, data.frame(Year=year, forested=nFor, unforested=nUnf))
  }

  if (year == start_year || year == end_year) {
    p <- ggplot(dfLCT, aes(x=x, y=y))
    p <- p + geom_raster(aes(fill=name))
    p <- p + geom_path(data=regionmap, size=0.1, colour="black", aes(x=long, y=lat, group=group))
    p <- p + coord_fixed(xlim=c(min(dfLCT$x), max(dfLCT$x)),
                         ylim=c(min(dfLCT$y), max(dfLCT$y)))
    p <- p + theme(legend.position = "bottom")
    p <- p + scale_fill_manual(values=c("unforested"="yellow", "forested"="darkgreen",
                                        "water"="lightblue"), drop=FALSE)
    p <- p + guides(fill = guide_legend(title=NULL, ncol = 4))
    label = paste0(nFor, " * km^2")
    p <- p + annotate("text", label=label, x=3e5, y=9.05e6,
                      color="white", parse=TRUE, size=6)
    label = paste0(nUnf, " * km^2")
    p <- p + annotate("text", label=label, x=3e5, y=8.95e6,
                      color="white", parse=TRUE, size=6)
    p <- p + labs(title=year)
    p <- p + xlab("easting")
    p <- p + ylab("northing")
    file <- paste0(getOption("fegloekRegion"), "_LUC_", year, ".pdf")
    print(p)
  }
}
```

\marginnote{
\textbf{Aufgabe}\\
Unkommentieren Sie innerhalb der Schleife über die Jahre die Zeilen mit "annotate" und setzen sie die x und y Koordinaten so, das die jeweiligen Flächen mit auf der Grafik stehen (Befehl extent(rLCT) gibt die Limits aus).
}

```{r, eval=FALSE}
forestExtent <- getOption("fegloekLUCExtent")
data.dir <- file.path(getOption("fegloekDataDir"), getOption("fegloekRegion"))
for (year in start_year:end_year) {
  file <- paste0("MCD12Q1_", year ,"-01-01.Land_Cover_Type_3.tif")
  dfLCT <- geotiff2df(file.path(data.dir, file), name="id", crop=forestExtent, valid_range = c(0, 253))
  
  # reproject border lines, if not yet done
  if (!exists("regionmap")) {
    rLCT <- raster(file.path(data.dir, file))
    rLCT = crop(rLCT, forestExtent)
    regionmap = borderSubset(rLCT)
  }

  dfLCT$name = ""
  dfLCT$name[dfLCT$id < 5 | dfLCT$id > 8] = "unforested"
  dfLCT$name[dfLCT$id > 4 & dfLCT$id < 9] = "forested"
  dfLCT$name[dfLCT$id == 0] = "water"

  nFor = length(dfLCT$name[dfLCT$name == "forested"])
  nUnf = length(dfLCT$name[dfLCT$name == "unforested"])

  if (year == start_year) {
    tsForest = data.frame(Year=year, forested=nFor, unforested=nUnf)
  } else {
    tsForest = rbind(tsForest, data.frame(Year=year, forested=nFor, unforested=nUnf))
  }

  if (year == start_year || year == end_year) {
    p <- ggplot(dfLCT, aes(x=x, y=y))
    p <- p + geom_raster(aes(fill=name))
    p <- p + geom_path(data=regionmap, size=0.1, colour="black", aes(x=long, y=lat, group=group))
    p <- p + coord_fixed(xlim=c(min(dfLCT$x), max(dfLCT$x)),
                         ylim=c(min(dfLCT$y), max(dfLCT$y)))
    p <- p + theme(legend.position = "bottom")
    p <- p + scale_fill_manual(values=c("unforested"="yellow", "forested"="darkgreen",
                                        "water"="lightblue"), drop=FALSE)
    p <- p + guides(fill = guide_legend(title=NULL, ncol = 4))
    
    ## label = paste0(nFor, " * km^2")
    ## p <- p + annotate("text", label=label, x=3e5, y=9.05e6,
    ##                  color="white", parse=TRUE, size=12)
    ## label = paste0(nUnf, " * km^2")
    ## p <- p + annotate("text", label=label, x=3e5, y=8.95e6,
    ##                  color="white", parse=TRUE, size=12)
    
    p <- p + labs(title=year)
    p <- p + xlab("easting")
    p <- p + ylab("northing")
    file <- paste0(getOption("fegloekRegion"), "_LUC_", year, ".pdf")
    pdf(file.path(getOption("fegloekFigDir"), file), paper="special", width=10, height=6)
    print(p)
    dev.off()
  }
}
```

Jetzt wird die Zeitreihe geplottet. Dafür werden die Spalten 'forested' und 'unforested' mit dem Befehl 'melt' in einer Spalte namens 'value' kombiniert und eine zusätzliche Spalte names 'variable' erzeugt, die die entsprechenden alten Spaltennamen 'forested'/'unforested' enthält. Falls Ihre zwei Klassen deutlich unterschiedliche Flächen aufweisen,
aktivieren Sie den facet_wrap Befehl. Denken Sie daran, die Variablen entsprechend ihrer obigen Definition
umzubenennen.

```{r}
tsForest = melt(tsForest, measure.vars=c("forested", "unforested"))
p <- ggplot(tsForest, aes(x=Year, y=value, fill=variable))
p <- p + geom_bar(stat="identity", position="dodge")
## p <- p + facet_wrap(~variable, ncol=1, scales="free_y")
```
```{r, eval=FALSE}
file <- paste0(getOption("fegloekRegion"), "_LUC_TS.pdf")
pdf(file.path(getOption("fegloekFigDir"), file), paper="special", width=10, height=6)
print(p)
dev.off()
```

```{r, fig.width=8, fig,height=5, echo=FALSE}
print(p)
```

# Hausaufgaben

1. Beschriften Sie die y-Achse korrekt (?xlab, ?ylab).

2.  In dem Skript wird das Verhältnis Wald zu nicht Wald in einem kleinem Ausschnitt betrachtet. Überlegen Sie sich eine eigene Klassifizierung (Urbanisierung, Landwirtschaft, Verbuschung, ...) Ihrer Region und passen Sie die Variablennamen und die Klassifizierung entsprechend an. Eventuell muss auch der zu benutzende Ausschnitt verändert werden (forestExtent), damit zum Beispiel eine Stadt enthalten ist.
 
# freiwillige Zusatzaufgaben

1. Beschriften Sie die x-Achsen mit ganzen Zahlen damit es eher einer Zeitachse mit Jahren entspricht (?scale_x_continuous).

2. Wählen Sie eine sinnvolle Farbgebung aus. Hilfe gibt es auf [docs.ggplot2.org](http://docs.ggplot2.org/current/)

3. Die Karte mit der räumlichen Verteilung kann auch für jedes Jahr geplottet werden. Diese Bilder können Sie zu einer Animation zusammen fügen.

# Literatur
