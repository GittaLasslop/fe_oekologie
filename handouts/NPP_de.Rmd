---
title: "Fernerkundung globale Ökologie: 3. NPP/GPP"
author: "[Lasslop](mailto:gitta.lasslop@senckenberg.de)/[Werner](mailto:christian.werner@senckenberg.de)"
bibliography: /home/gitta/R/Lehre/FE_OEKOLOGIE/fe_oekologie_2018/handouts/literatur.bib
classoption: a4paper
## lang: de-DE
output:
  pdf_document:
##    latex_engine: xelatex
    fig_caption: yes
    includes:
#      in_header: styles.tex
##    toc: true
    highlight: default
---

# Netto-/Brutto-Primärproduktion

Das MODIS Kürzel ist [MOD17A3](https://lpdaac.usgs.gov/dataset_discovery/modis/modis_products_table/mod17a3).

## Literatur
 
 @zhao_drought-induced_2010; @zhao_improvements_2005; @nemani_climate-driven_2003 und zum vertiefen: @de_kauwe_satellite_2016 und Kommentare, sowie Antworten zu  @zhao_drought-induced_2010

## Initialisieren
Sollten Sie eine Fehlermeldung beim Laden der Pakete bekommen installieren Sie diese bitte als erstes nochmal neu mit dem code aus der 1. Stunde:
```{r, message=FALSE, warning=FALSE,eval=FALSE}
for (p in c("raster", "rgeos", "ggplot2", "rworldmap", "maps", 
            "mapproj", "rgdal", "devtools")) {
  if (!require(p, character.only=TRUE)) {
    install.packages(p)
    library(p, character.only=TRUE)
  }
}

```

Laden der benötigten Pakete, sowie initialisieren der Umgebungsvariablen.
```{r, message=FALSE, warning=FALSE}
library(raster)
library(ggplot2)
library(plyr)
setwd('/home/gitta/R/Lehre/FE_OEKOLOGIE/fe_oekologie_2019/handouts')
```


```{r, echo=FALSE}
source(file.path("R", "variables.R"), encoding=getOption("encoding"))
source(file.path("R", "functions.R"), encoding=getOption("encoding"))
```
Wechseln Sie in ihr Arbeitsverzeichnis und kopieren Sie sich die Daten für die heutige Stunde in das Verzeichnis
```{r, message=FALSE, warning=FALSE,eval=FALSE}
'data/NPP/BORNEO'
```


## Einlesen der Daten


Eine Datei, in der die NPP-Werte sind, wird geladen, dafür erweitern wir die Funktion 'geotiff2df()' basierend auf dem code der letzen Stunde. Die Funktion 'geotiff2df()' soll die input Parameter "file" (Dateiname), "name" (den Namen für die Datenvariable, hier NPP), valid\_range und scale\_factor haben. Als Rückgabe brauchen wir einen dataframe mit drei Spalten: x und y (lat und lon) Werte und die Werte der Datenvariablen.


Die Datei soll mit raster() gelesen werden und dann in einen dataframe mit as.data.frame(rasterToPoints(raster)) umgewandelt werden. Zusätzlich müssen noch die Spaltennamen in "x","y" und den input parameter "name" (hier NPP) geändert werden. Werte außerhalb der Limits (valid\_range) sollen auf NA gesetzt werden (z.B. data[data <= valid_range[1]] = NA) und die Variable mit dem scale\_factor multipliziert werden.

Funktionen in R haben die allgemeine Form:
```{r,eval=FALSE}
Funktionsname <- function(InputPar1,InputPar2,...){
  Rcode
  return(value)
}
```

----------------------
***Aufgabe***
Finden Sie wieder "scale factor" und "valid range" auf der dem 
heutigen Thema entsprechenden MODIS Web-Seite (MOD17A3, siehe oben) und 
speichern Sie scale factor in die Variable "nppScaleFactor" und 
die Limits in die Variable "nppValidRange". Wenn Sie die gesuchten 
Variablen nicht finden können, nehmen Sie nppScaleFactor = 1 und
nppValidRange = c(0, 1.e30). 
------------------------------------

Dann verwenden wir die Funktion um die Daten zu lesen:
```{r, echo=FALSE}
nppScaleFactor <- 0.0001
nppValidRange  <- c(0, 65500)
```

```{r}
data.dir <- 'data/NPP/BORNEO'
file <- file.path(data.dir, "MOD17A3_2010-01-01.Npp_1km.tif")
dfNPP <- geotiff2df(file, "NPP", valid_range = nppValidRange, 
                    scale_factor = nppScaleFactor)
```

Dann laden wir die Landnutzungsklassen, anhand welcher die NPP-Werte klassifiziert werden. Die LCT3lookuptable müssen Sie wie schon vorher mit `read.table()` einlesen.

```{r}
file <-file.path(data.dir, "MCD12Q1_2010-01-01.Land_Cover_Type_3.tif")
dfLCT <- geotiff2df(file, 'id', valid_range = c(0, 253))
dfLCT = merge(dfLCT, LCT3lookuptable, by="id", all.x=TRUE)
```

## Datenprozessierung

Verschmelzen der zwei data.frames.

```{r}
dfData <- merge(dfNPP, dfLCT, by=c("x", "y"))
```

--------------------------
***Aufgabe***
Machen alle Ökosysteme in Ihrer Region Sinn? Sie können den Befehl
'table' nutzen oder den mächtigeren (aber auch komplizierteren) Befehl 
'ddply' aus dem Paket 'plyr'. Überlegen Sie anhand des Resultats,
welche Ökosysteme Sie von der Analyse ausnehmen können und wie Sie
das machen.
--------------------------------------------------------

```{r}
ddply(dfData, c("id", "name"), summarize, count=length(id))
table(dfData$name)
```

## Grafikausgabe

Es wird ein sogenannter boxplot erzeugt.

```{r, message=FALSE, warning=FALSE}
p <- ggplot(dfData, aes(x=name, y=NPP, fill=name))
p <- p + geom_boxplot()
p <- p + guides(fill=FALSE)
p <- p + xlab(NULL)
p <- p + ylab("NPP [kg(C)/m^2]")
p <- p + coord_flip()
```
```{r, eval=FALSE}
file <- paste0("plots/NPP/Borneo_NPP.pdf")
pdf( file, paper="special", width=8, height=8)
print(p)
dev.off()
```

```{r, echo=FALSE, fig.width=6, fig.height=4, fig.ext='png', dpi=150}
print(p)
```

# Hausaufgaben

1. Änderen Sie die Farbgebung in der Abbildung. **(1 Punkt)**

2. Was bewirkt der Befehl *coord_flip()*? **(0.5 Punkt)**

3. Wie können Sie die Zahl 2.7645 auf zwei Nachkommastellen runden? **(0.5 Punkt)**

4. Es gibt auch eine entsprechende GPP Datei (Brutto-Primärproduktion). Machen Sie den gleichen Boxplot für GPP. **(1 Punkt)**

5. Erstellen Sie eine Karte von NPP (siehe map_de.R Skript). **(2 Punkte)**

6. Setzen Sie NPP ins Verhältnis zu GPP. Erzeugen Sie einen Boxplot des Verhältnisses NPP:GPP für alle Landbedeckungsklassen **(2 Punkte)**.
    
# Literatur